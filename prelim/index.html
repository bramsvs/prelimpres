<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>reveal.js – The HTML Presentation Framework</title>

  <meta name="description" content="A framework for easily creating beautiful presentations using HTML">
  <meta name="author" content="Hakim El Hattab">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="stylesheet" href="../css/reveal.css">
  <link rel="stylesheet" href="../css/theme/delft.css" id="theme">

  <!-- Theme used for syntax highlighting of code -->
  <!-- <link rel="stylesheet" href="../lib/css/zenburn.css"> -->
  <link rel="stylesheet" href="../node_modules/highlightjs/styles/vs.css">

  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,600,600i" rel="stylesheet">

  <link rel="stylesheet" type="text/css" href="http://tikzjax.com/v1/fonts.css">
  <script src="http://tikzjax.com/v1/tikzjax.js"></script>
  <script src="path/to/autolinker/dist/Autolinker.min.js"></script>
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? '../css/print/pdf.css' : '../css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
    var revealInitialized = [];
  </script>

  <script src="../node_modules/citation-js/build/citation.js"></script>
  <script src="../node_modules/autolinker/dist/Autolinker.min.js"></script>

  <!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
</head>

<!-- 
 

 -->

<body>

  <div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
      <section>
        <h1>Actuator fault detection</h1>
        <h3></h3>
        <p>
          <small>Bram Strack van Schijndel</small>
        </p>
        <aside class="notes" data-markdown>Good morning</aside>
      </section>


      <section>
        <section>
          <h2>Why fault tolerant control?</h2>
          <aside class="notes" data-markdown>There are easy and complex answers, easy answer: quadrotors fail all the
            time.

            Lets look at some examples of failing quadrotors</aside>
        </section>

        <section data-background-video="youtube/downloads/3v0GQX5Ptyc.mp4" data-video-time="83">
          <aside class="notes" data-markdown>These propellers are attached with o-rings, not smart.</aside>
        </section>

        <section data-background-video="youtube/downloads/8qMpE-hr2X0.mp4" data-video-time="78">
          <aside class="notes" data-markdown>Quadrotor failures in a guarden.</aside>
        </section>

        <section data-background-video="youtube/downloads/shgeDmgA36I.mp4" data-video-time="44">
          <aside class="notes" data-markdown></aside>
        </section>

        <section data-background-video="youtube/downloads/-rJi_78Ef_E.mp4" data-video-time="1">
          <aside class="notes" data-markdown>This is a sad and difficult case because of ground interaction</aside>
        </section>

        <section data-background-video="youtube/downloads/D-988dJbSJU.mp4" data-video-time="10">
          <aside class="notes" data-markdown>They also fail in research settings</aside>
        </section>

        <section data-background-video="youtube/downloads/oWj3ivhWr40.mp4" data-video-time="68">
          <aside class="notes" data-markdown>This one is funny because it includes my research question.</aside>
        </section>

        <section data-background-video="youtube/downloads/kq_Hgg5J-rQ.mp4" data-video-time="716">
          <aside class="notes" data-markdown>Please look at how nice the camera stays is kept steady.</aside>
        </section>
        <!-- <section data-background-iframe="https://youtube.com/embed/3v0GQX5Ptyc?autoplay=1&start=87" data-background>
        </section>
        <section data-background-iframe="https://youtube.com/embed/8qMpE-hr2X0?autoplay=1&start=78" data-background>
        </section>
        <section data-background-iframe="https://youtube.com/embed/shgeDmgA36I?autoplay=1&start=44" data-background>
        </section>
        <section data-background-iframe="https://youtube.com/embed/-rJi_78Ef_E?autoplay=1&start=1" data-background>
        </section>
        <section data-background-iframe="https://youtube.com/embed/D-988dJbSJU?autoplay=1&start=10" data-background>
        </section>
        <section data-background-iframe="https://youtube.com/embed/oWj3ivhWr40?autoplay=1&start=68" data-background>
        </section> -->


        <!-- <section data-background-iframe="https://www.youtube.com/embed/kq_Hgg5J-rQ?autoplay=1&start=715"
          data-background>
          <aside class="notes" data-markdown>Dji Inspire 2 losing prop, 3 prop flight</aside>
        </section> -->

      </section>


      <section>
        <style>
          .node {
            cursor: pointer;
          }

          .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 1.5px;
          }

          .node text {
            font: 10px sans-serif;
          }

          .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
          }

          body {
            overflow: hidden;
          }
        </style>

        <section>

          <h2>Fault tree analysis</h2>
          <!-- <q>Find a fault detection and isolation method that detects actuator faults, enabling fault tolerant
            control.</q> -->
          <div class="stack-container">
            <img src="tikz/FT_base.svg" width="120%" class="fragment fade-out no-border center no-shadow stack"
              data-fragment-index="0"></img>
            <img src="tikz/FT_base_prob.svg" width="120%" class="fragment fade-in no-border center no-shadow stack"
              data-fragment-index="0"></img>
          </div>
          <code class="no-code-but-p">
          <aside class="notes" data-markdown>
Putting these failures in a fault tree gives us something like this ... there are many ways to structure this, this is just one way ...
System failure can for example also be loss of control or control system failure ... now we have this fault tree we can guestimate probabilities and quantify probability of system failure ... those gates are or gates so this adds up.
          </aside>
        </code>
        </section>

        <section>
          <h2>Adds up</h2>
          <p>
            $P(A \cup B)=P(A)+P(B)$
          </p>
        </section>

        <section>
          <h2>Fault tree analysis</h2>
          <img src="tikz/FT_ftc.svg" width="120%" class="no-border center no-shadow" data-fragment-index="0"></img>
          <aside class="notes" data-markdown>
            We want to prevent a simple actuator failure turning into system failure ... we do this by adding a fault
            tolerant controller

            This adds an AND gate.

            This is just one way of looking at this ... another way to look at this problem is from the concept of
            graceful degradation.</aside>
        </section>

        <section>
          <h2>Graceful degradation</h2>
          <code class="no-code-but-p" data-markdown>
Give up control functions like:
- Yaw
- Altitude
- Pitch and/or roll (thrust vector)
- Position
          </code>
          <aside class="notes" data-markdown>
            What we're looking is a system that degrades gracefully, from a functional perspective.

            Which, among other thing, is about making sure that simple failures don't develop into more serious mishaps.

            Lets look at an example, you may already have seen.
          </aside>
        </section>

        <section>
          <h2>Example</h2>
          <code class="no-code-but-p" data-markdown>
One actuator shuts down so:
- Yaw control is given up
- Flight envelope shrinks

But still limited control over thrust vector
            </code>
        </section>


        <section data-background-video="youtube/downloads/ScYDOqFGOhk.mp4" data-video-time="37">
          <aside class="notes" data-markdown>It is about saving what we can.</aside>
        </section>


        <section>
          <h2>Graceful degradation</h2>
          <code class="no-code-but-p" data-markdown>
Give up control functions like:
- Yaw
- Altitude
- Pitch and/or roll (thrust vector)
- Position

While saving what we can
            </code>
          <aside class="notes" data-markdown>
            So this was just one example.

            Sihao is trying to control quadrotors which have even more damage.
          </aside>
        </section>


        <section>
          <h2>Challenging</h2>
          <code class="no-code-but-p" data-markdown>
Because failures:
- Come in many different modes
- Happen in real-time

This leads complex control system designs:
- Unintended consequences
- Are difficult to test
              </code>
          <aside class="notes" data-markdown>
            Challenging because when something bad happens, your system dynamics change ...
            so you quickly need to do some fast system identification to control it.

            And at the same time your flight envelope is shrinking.

            Then, you also have to prove that all that extra complexity is actually improving safety.
          </aside>
        </section>

        <section>
          <h2>Why actuator fault detection?</h2>
          <code class="no-code-but-p" data-markdown>
Helps picking a control strategy
            </code>
          <aside class="notes" data-markdown>
            .. at least we hope it does.

            There is luckily some previous work. Lets look at that.</aside>
        </section>

      </section>

      <section>
        <section>
          <h2>Previous work</h2>
          Two videos, three papers
          <aside class="notes" data-markdown></aside>
        </section>

        <section data-background-video="youtube/downloads/bsHryqnvyYA.mp4" data-video-time="14">
          <aside class="notes" data-markdown>
            This is one of the more famous videos. Already done in 2013.

            Unfortunately they didn't publish a fault detection method. Probably used some threshold on attitude and
            called
            it a day.

            But they did file a patend on the control method.
          </aside>
        </section>

        <section>
          <p>Mark W. Mueller and Raffaello D'Andrea</p>

          <aside class="notes" data-markdown>
            And the researchers building this moved on working on other projects.
          </aside>
        </section>

        <section data-background-video="youtube/downloads/ek0FrCaogcs.mp4" data-video-time="32">
          <aside class="notes" data-markdown>This is the same group but outside, a couple of months later.</aside>
        </section>


        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Peng.pdf#zoom=160&page=1">
          <aside class="notes" data-markdown>Lets look at the first paper, this is 2015.</aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Key points
- Pseudoinverse
 - 4 actuators,
 - controlling 4 degrees of freedom
- Not handling noise
- Simulation study
            </code>
          <aside class="notes" data-markdown>They exploit the fact that the control effectiveness matrix is invertible.
          </aside>
        </section>

        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Peng.pdf#zoom=160&page=3">
          <aside class="notes" data-markdown>Lets quickly take a look at their control effect model. Because it gives
            you
            some insight in the problem we are trying to solve.
          </aside>
        </section>

        <section>
          <p>$\left[ \begin{array}{c}{T} \\ {\tau_{x}} \\ {\tau_{y}} \\ {\tau_{z}}\end{array}\right]=\left[
            \begin{array}{cccc}{b} & {b} & {b} & {b} \\ {0} & {-L b} & {0} & {L b} \\ {L b} & {0} & {-L b} & {0} \\
            {-d}
            & {d} & {-d} & {d}\end{array}\right] \left[ \begin{array}{c}{\omega_{1}^{2}} \\ {\omega_{2}^{2}} \\
            {\omega_{3}^{2}} \\ {\omega_{4}^{2}}\end{array}\right]$</p>
          <code class="no-code-but-p" data-markdown>
with: <br>
- thrust $T$, torques $\tau$
- thrust constant $b$, torque constant $d$, arm length $L$
- rotor speeds $\omega$
              </code>
          <aside class="notes" data-markdown>
            On the left are forces and moments produced by the actuators as a function of the rotor speeds.

            If we know the forces, moments and constants we can invert the matrix, get the rotor speeds you would expect
            ... and compare them with the commanded or measured ones.
          </aside>
        </section>

        <section>
          Thrust:
          <p>
            $\hat{T}=m(g-\hat{w}) /(\mathbf{C} \hat{\phi} \mathbf{C} \hat{\theta})$
          </p>
          Torques:
          <p>
            $\begin{aligned} \hat{\tau}_{x} &=I_{x} \hat{p}-\left[\left(I_{y}-I_{z}\right) \hat{q} \hat{r}+I_{r}
            \hat{q} \hat{\omega}_{r}\right] \\ \hat{\tau}_{y} &=I_{y} \hat{\dot{q}}-\left[\left(I_{z}-I_{x}\right)
            \hat{r} \hat{p}-I_{r} \hat{p} \hat{\omega}_{r}\right] \\ \hat{\tau}_{z} &=I_{z}
            \hat{r}-\left[\left(I_{x}-I_{y}\right) \hat{p} \hat{q}+I_{r} \hat{\omega}_{r}-k_{r} \hat{r}\right]
            \end{aligned}$
          </p>
          <code class="no-code-but-p" data-markdown>

                </code>
          <aside class="notes" data-markdown>
            Problem is you can't measure these forces and moments directly ... sensors also measure disturbances ... and
            for example aerodynamic moments when youre flying at speed
          </aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Next paper
                </code>
          <aside class="notes" data-markdown></aside>
        </section>

        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Smeur.pdf#zoom=160&page=1">
          <aside class="notes" data-markdown>This paper does not give a fault detection method ... but it does give a
            method for estimating control effectiveness ... which is what we need ...
          </aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Key points
- INDI, so:
 - Takes derivative of rotational rates
 - Makes use of rotor speed measurements
 - Runs both measurements through same LP filter
- Adaptive: 
 - Estimating 16 + 4 control effectiveness parameters
 - Using LMS
 - Takes seconds to converge
- Works in real world
          </code>
          <aside class="notes" data-markdown>Unfortunately, it takes seconds to converge
            instead of miliseconds, but it is a nice starting point.</aside>
        </section>

        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Smeur.pdf#zoom=180&page=14">
          <aside class="notes" data-markdown>These charts show the adapting control effectiveness. This all happened
            around 2016</aside>
        </section>

        <!-- 
        <section data-background-iframe="https://youtube.com/embed/bsHryqnvyYA?autoplay=1&start=14" data-background>
          <aside class="notes" data-markdown>
            - No fault detection method published

            https://hiperlab.berkeley.edu/publications/
          </aside>
        </section>

        <section data-background-iframe="https://youtube.com/embed/ek0FrCaogcs?autoplay=1&start=32" data-background>
          <aside class="notes" data-markdown></aside>
        </section> -->

        <section>
          <code class="no-code-but-p" data-markdown>
## Last paper
                  </code>
          <aside class="notes" data-markdown></aside>
        </section>

        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Zhong.pdf#zoom=160&page=1">
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Key points
- Handles actuator failures *and* disturbances 
- Very recent, state of art
- Linearized around hover
- Very complex..
                </code>
          <aside class="notes" data-markdown>Disturbances are difficult to estimate because they give they can be
            indistinguishable from actuator failures.</aside>
        </section>

        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Zhong.pdf#zoom=160&page=7">
        </section>

        <!-- https://stackoverflow.com/questions/20562543/zoom-to-fit-pdf-embedded-in-html -->
        <section data-background-iframe="media/Zhong.pdf#zoom=160&page=8">
          <aside class="notes" data-markdown>All these numbers correspond to the equations from previous slide.</aside>
        </section>


      </section>

      <script>
        const Cite = require('citation-js')

        window.Cite = Cite
        const bibliographyText = fetch('bibliography.bib')
          .then(response => {
            return response.text()
          })
          .then(response => {
            const bib = Cite.parse.bibtex.text(response)

            // console.log(bib)

            const formatSingle = (label) => {
              // console.log(label)
              const entry = bib.find(entry => entry.label === label)

              let example = new Cite(entry)
              // console.log(entry)
              return example
                .format('bibliography', {
                  format: 'html',
                  template: 'apa',
                  lang: 'en-US'
                })
            }

            document.querySelectorAll('[data-bib-label]').forEach(el => {
              const label = el.getAttribute('data-bib-label')
              const unlinkedText = formatSingle(label)
              const linkedText = Autolinker.link(unlinkedText);
              el.innerHTML = linkedText
              // console.log(el)
            })

          })
      </script>

      <section>

        <section>
          <h2>Research gap</h2>
          <code class="no-code-but-p" data-markdown>
- Often complex solutions
- Often questionable assumptions
- Little real world validation
                  </code>
          <aside class="notes" data-markdown>This is also based on papers I didn't show you.</aside>
        </section>

        <section>
          <h2>Research goal</h2>
          <q>Find an efficient and reliable fault detection and isolation method that detects actuator faults.</q>
          <p>
          </p>
          <aside class="notes" data-markdown>Lets look at the efficient and reliable.
          </aside>
        </section>

        <section>
          <h2>Efficient</h2>
          <code class="no-code-but-p" data-markdown>
Little waste of resources like:
- Developer time
- Computational time
- MAV operator time
            </code>
          <aside class="notes" data-markdown>We want companies to apply our methods. So, they need to be cheap and easy
            to implement.

            They need have low complexity.

            And not cause more headaches than they prevent.
          </aside>
        </section>

        <section>
          <h2>Reliable</h2>
          <code class="no-code-but-p" data-markdown>
- Highly sensitive to actuator failures
- Low probability of false alarm
- Low complexity
          </code>
          <aside class="notes" data-markdown>First point is obvious. Second one harder. For example: when taking off,
            doing manoeuvres. How do you validate this?
          </aside>
        </section>

        <section>
          <h2>Solution space</h2>
          <!-- TODO: check with Sihao -->
          <code class="no-code-but-p" data-markdown>
- Input signals?
 - Direct, filtered and/or debiased IMU measurements
 - Rotor speed measurements or setpoints
 - Fused estimator outputs
- Observers?
 - Thau, Kalman, Luenberger
 - Direct pseudoinverse
- Estimators?
 - LMS, RLS, Kalman, ML, moving window, forgetting factor
- Detection & isolation logic?
 - Thresholds on residuals or estimated parameters
 - Fuzzy
        </code>
          <aside class="notes" data-markdown>
            This is a bit of a showdown of all ideas found in literature and at the coffee machine.

            You can look at it for a second.
          </aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## So,
- No analytical solution
- Lots off tradeoffs
          </code>
          <aside class="notes" data-markdown>This means we need iterations to get to an efficient and
            reliable solution.</aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Problem
Iterations are slow
            </code>
          <aside class="notes" data-markdown>The problem is iterations are slow.

            There are many reasons why iterations are slow.

            One of them is because it takes months to implement anything in Paparazzi.</aside>
        </section>

        <section>
          <h2>Research strategy</h2>
          <p>
            Two main steps:
            <ol>
              <li>
                <i>Dramatically</i> speed up iterative design process
              </li>
              <li>
                Iterate on problem
              </li>
            </ol>
          </p>
          <aside class="notes" data-markdown>So that bring me to the research strategy. Lets see what iteration looks
            like.</aside>
        </section>
      </section>

      <section>
        <section>
          <h2>Iteration</h2>
          <p>
            <ol>
              <li>
                Design, simulate system in Simulink
              </li>
              <li>
                Implement solution in quadrotor/MAV
              </li>
              <li>
                Run some flight test sequence
              </li>
              <li>
                Retrieve, visualize log data
              </li>
              <li>
                Check assumptions, performance and adjust
              </li>
            </ol>
          </p>
          <aside class="notes" data-markdown>
            Step 1 includes some verification step
            Step 3 to 5 include some validation

            The best way to speed things up is by applying automation.

            Lets look at an example.
          </aside>
        </section>

        <section>
          <h2>Automation example</h2>
          <code class="no-code-but-p" data-markdown>
Goal is to automate step 2 (implementation),

by going from a Simulink model to C++ library to be used in PX4
            </code>
          <aside class="notes" data-markdown>
            U picked this example because it's most extreme.

            This process cuts implementation time from the months to weeks range to the
            days to minutes range.

            Let's go through example, it starts a bit silly.</aside>
        </section>

        <section>
          <img src="media/ratecontrol.png" class="no-border"></img>
          <aside class="notes" data-markdown>We start with a model, don't look at the model.</aside>
        </section>

        <section>
          <img src="media/coder_options.png" class="no-border"></img>
          <aside class="notes" data-markdown>We open the Simulink Coder options window and lets assume I figured out
            which boxes to check and buttons to click</aside>
        </section>

        <section>
          <img src="media/ratecontrol.png" class="no-border"></img>
          <img src="media/coder_button.png" class="inset fragment" style="left: 420px; top: 20px"></img>
          <aside class="notes" data-markdown>The issue, is: I can only communicate this process via word of mouth ... or
            by writing some manual or putting it in the appendix of my report.

            This means the process will get lost and students get stuck writing C in Paparazzi forever.

            Or stay in the warm and cozy Simulink safe zone.
          </aside>
        </section>

        <section>
          <pre class="matlab"><code>
% codegen.m

%% Script meant to:
% - generate C++ code from Simulink model
% - move code to 'simulink_wrapper', px4-module
% - also copy needed CMakeLists.txt
%%

%% Build Simulink subsystem
model = 'quadrotor/Controller/Primary_axis_INDI_controller/attitude_controller/INDI_allocator'
rtwbuild(model)
% rtwbuild clears all variables!

verbose = true;

%% Unzip "packNGo"-package to temp folder
modelName = 'INDI_allocator';
tempUnzipDir = './temp/';
unzip(strcat(modelName, '.zip'), strcat(tempUnzipDir, modelName));

%% Move generated files to codegen folder in px4
px4CodegenParentDir = '~/src/Firmware/src/modules/simulink_wrapper/';
px4CodegenDirName = 'codegen';
px4CodegenDir = strcat(px4CodegenParentDir, px4CodegenDirName);
rmdir(px4CodegenDir, 's');
mkdir(px4CodegenParentDir, px4CodegenDirName);

tempFilesAndFolders = dir(strcat(tempUnzipDir, '**'));

successCount = 0;
for i = 1:numel(tempFilesAndFolders)
    fileOrFolder = tempFilesAndFolders(i);
    
    if fileOrFolder.isdir == false
        file = strcat(fileOrFolder.folder, '/', fileOrFolder.name);
        successCount = successCount + copyToPx4Codegen(file, px4CodegenDir, verbose);
    end
end

% Move CMakeLists.txt..
currentPath = fileparts(mfilename('fullpath'));
cmakePath = strcat(currentPath, '/CMakeLists.txt');
successCount = successCount + copyToPx4Codegen(cmakePath, px4CodegenDir, verbose);

fprintf('Files moved: %i\n', successCount)

function [success] = copyToPx4Codegen(file, px4CodegenDir, verbose)
    [success, message] = copyfile(file, px4CodegenDir);
    if verbose, disp(message), end
end
              </code></pre>
          <aside class="notes" data-markdown>This is better. Some part of the process scripted, can send this around via
            email, put in code repository.
            But: - Can't work with multiple people on it.
            - End up with copies.
            - Untested.
            - Doesn't fit well in rest of pipeline
            - There is more I want to automate
          </aside>
        </section>

        <section>
          <!-- <h2>Python</h2> -->
          <img src="media/mostlovedlangs.png" class="no-border center" height="500px"></img>
          <small><a
              href="https://insights.stackoverflow.com/survey/2019#technology-_-most-loved-dreaded-and-wanted-languages">Stackoverflow
              2019 Developer Survey</a></small>
          <aside class="notes" data-markdown>So I made a big jump to Python, I didn't knew Python so wanted to learn it.</aside>
        </section>

        <section>
          <h2>Python</h2>
          <pre class="python"><code>
# test_matlablib.py

from matlablib import Matlab, Model, codegen

PROJECT_ROOT = "./simulink_model"
SYSTEM_FILE = "./Control/RateControl/RateControl.slx"
MODEL = "RateControl"

def test_codegen(project):
    model = Model(project, SYSTEM_FILE, MODEL)
    codegen(model)
    model.engine.quit()
          </code></pre>

          <aside class="notes" data-markdown>Using</aside>

        </section>

        <section>
          <!-- <h2>Python</h2> -->
          <pre class="python"><code>
# 'simulink_model/config.py'

MODEL_CONFIGS: Dict[str, ModelConfig] = {
  "RateControl": ModelConfig(
      system_file="./Control/RateControl/RateControl.slx",
      model="RateControl",
      parameters=SimulinkCoderParameters(),
      target_directory=str(
          Path(
              "~/src/Firmware/src/modules/sl_control/RateControl"  # is PX4 library
          ).expanduser()
      ),
      px4_input_log_topic="rate_control_input",
      example_input_data="./Control/RateControl/example_rate_control_input_0.csv",
      example_logsout_data="./Control/RateControl/example_rate_control_input_0_logsout.mat",
  ),
  "AttitudeControl": ModelConfig(
      system_file="./Control/AttitudeControl/AttitudeControl.slx",
      model="AttitudeControl",
      parameters=SimulinkCoderParameters(),
      target_directory=str(
          Path(
              "~/src/Firmware/src/modules/sl_control/AttitudeControl"
              # is PX4 library
          ).expanduser()
      ),
      px4_input_log_topic="attitude_control_input",
      example_input_data="",
  ),
  "PosDirectControl": ModelConfig(
      system_file="./Control/PosDirectControl/PosDirectControl.slx",
      model="PosDirectControl",
      parameters=SimulinkCoderParameters(),
      target_directory=str(
          Path(
              "~/src/Firmware/src/modules/sl_pos_direct_control/PosDirectControl"
              # is PX4 library
          ).expanduser()
      ),
      px4_input_log_topic="pos_direct_control_input",
      example_input_data="",
  ),
  "URControl": ModelConfig(
      system_file="./Control/URControl/URControl.slx",
      model="URControl",
      parameters=SimulinkCoderParameters(),
      target_directory=str(
          Path(
              "~/src/Firmware/src/modules/sl_urcontrol/URControl"
              # is PX4 library
          ).expanduser()
      ),
      px4_input_log_topic="urcontrol_input",
      example_input_data="",
  ),
}
              </code></pre>
          <aside class="notes" data-markdown>Configurable, example data are used for automated testing. Do the tests
            still run if the
            model changes?</aside>
        </section>

        <section>
          <h2>Command line interface (CLI)</h2>
          <pre class="shell"><code>
$ dc 
Usage: dc [OPTIONS] COMMAND [ARGS]...

Options:
  --version  Show the version and exit.
  --help     Show this message and exit.

Commands:
  codegen     Run MATLAB code generation.
  print-path  Print Python path.
  qgc         Start QGroundControl.
  replay      Run ulog file replay.
  toptest
$ █
              </code></pre>
          <aside class="notes" data-markdown>Solution that scales to multiple use cases and is friendly to new people
          </aside>
        </section>

        <section>
          <pre class="shell"><code>
$ dc codegen --help
Usage: dc codegen [OPTIONS]

  Run MATLAB code generation.

Options:
  -m, --model [RateControl|AttitudeControl|PosDirectControl|URControl]
                                  Model options are defined in
                                  `simulink_model/config.py`  [required]
  --help                          Show this message and exit.
$ █
          </code></pre>

          <aside class="notes" data-markdown>(example) codegen help,
            note model options
            This is why Sihao and Matthias enjoy
            working with me so much.</aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Recap
Went from:
- Clicking buttons
- To a script
- To functions/classes
- To adding configuration file
- To building command line interace
                </code>
          <aside class="notes" data-markdown></aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Some benefits
- Faster progress in advancing flight control
- More repeatable experiments and results
- Much faster onboarding of new people
            </code>
          <aside class="notes" data-markdown>Again, went from months/weeks to days/minutes.</aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Lessons learned
Must consume and build scriptable interfaces:
- Consume Matlab Python API
- Build CLI with Python Click package
                </code>
          <aside class="notes" data-markdown></aside>
        </section>


        <section>
          <code class="no-code-but-p" data-markdown>
## More lessons learned

Only worth the effort if more people benefit and contribute back.

Need support structure to facilitate this sharing and creation:
- Source control
- Automated testing
- Readme, documentation
- Good IDE support
                  </code>
          <aside class="notes" data-markdown>Organisational wise. Applies to many software project, open source
            projects. Must make
            the barrier to entry very low.</aside>
        </section>

        <!-- <section>
          <code class="no-code-but-p" data-markdown>
## Same thinking applies to:
- Setting up developer environment
- Setting up OptiTrack, ground control system
- More
                </code>
          <aside class="notes" data-markdown>Think about retrieving log data </aside>
        </section> -->

        <section>
          <code class="no-code-but-p" data-markdown>
## Next steps
- Build interface in PX4 with codegenned library
- Fly, log data
- Replay flight data in Simulink (big shortcut)
              </code>
          <aside class="notes" data-markdown>Now we have our codegenned library.
            We can do some tricks.</aside>
        </section>

      </section>

      <section>

        <section>

          <img src="diagrams/process-prelim.svg" width="60%" class="no-border center no-shadow"></img>
          <aside class="notes" data-markdown>
            This is what the codegen and replay process looks like.

            Fat arrow is the codegen.

            Have the fault detection in an on- and offline environment.

            With Simulink on top, Bebop 2 running PX4 at the bottom.
          </aside>
        </section>

        <section>
          <code class="no-code-but-p" data-markdown>
## Failure case
Propeller ejection
* Easier to replicate than broken arm
          </code>
          <aside class="notes" data-markdown>
            Have to pick a failure case.

            There are many options possible.
          </aside>
        </section>

        <section>
          <img height="600px" src="media/carved_out_prop.jpg" style="margin: 15px auto; display: block">
          <aside class="notes" data-markdown>

          </aside>
        </section>

        <section data-background-video="media/prop_eject_recover.mp4" data-video-time="0">
          <aside class="notes" data-markdown>
            This is without a fault detection delay.
          </aside>
        </section>

        <section data-state="prop-eject" data-background-video="media/prop_eject.mp4" data-video-time="1">
          <p id="propEjectTime" style="color: white; text-align: right; padding-right: 150px">0 ms<br>0 samples</p>
          <aside class="notes" data-markdown>
            Look at front right propeller (most left one for us)
          </aside>
        </section>
      </section>

      <section>
        <section>
          <h2>Current state of solution</h2>
          <aside class="notes" data-markdown>
            Step 1 of research strategy was to speed up iteration.

            Lets look at step 2.
          </aside>
        </section>


        <section>
          <h2>Remember solution space?</h2>
          <img src="media/ratecontrol.png" class="no-border"></img>
          <aside class="notes" data-markdown>
            Lots of cooking
          </aside>
        </section>


        <section>

          <img src="diagrams/system-prelim.svg" width="70%" class="no-border center no-shadow"></img>
          <aside class="notes" data-markdown>
            Current state of affaires
          </aside>
        </section>

        <!-- /home/bramsvs/src/fddpaper/diagrams/system.pdf -->


        <section>
          <h2>Regression model</h2>
          <p>$$
            \begin{bmatrix}
            \dot{p} \\
            \dot{q} \\ \hdashline
            a_z \\
            \end{bmatrix}
            =
            \begin{bmatrix}
            G_p \omega_1^2 & -G_p \omega_2^2 & -G_p \omega_3^2 & G_p \omega_4^2 \\
            G_q \omega_1^2 & G_q \omega_2^2 & -G_q \omega_3^2 & -G_q \omega_4^2 \\ \hdashline
            -G_{a_z} \omega_1^2 & -G_{a_z} \omega_2^2 & -G_{a_z} \omega_3^2 & -G_{a_z} \omega_4^2 \\
            \end{bmatrix}
            \begin{bmatrix}
            k_1 \\
            k_2 \\
            k_3 \\
            k_4 \\
            \end{bmatrix}
            $$</p>
          <code class="no-code-but-p" data-markdown>
Estimating scaling factor $k$, 0 means total failure, 1 nominal effect
          </code>
          <aside class="notes" data-markdown>
            Nicely filters out disturbances.
          </aside>
        </section>

        <section>
          <h2>Binary classification problem</h2>
          <code class="no-code-but-p">
            Given variance $ \sigma^2_k $, we can compute the probability
            <br>
            <br>
             $$P_\text{fail} = P(k < k_\text{thres})$$
             <small>
                with $k_\text{thres} = 0.25$
              </small>
            <br><br>
            Then
            $$
            \text{act}_{i_\text{failed}} =
            \begin{cases}
            1 & \text{if}\ P_\text{fail} > P_\text{thres}\\
            0 & \text{if}\ P_\text{fail} < P_\text{thres}\\
            \end{cases}
            $$
            <small>
              with $P_\text{thres} = 0.9$
            </small>
          </code>
          <aside class="notes" data-markdown>
            Simplest version
          </aside>
        </section>

        <section data-background-video="media/vibrating_mess.mp4" data-video-time="2">
          <aside class="notes" data-markdown>
            Nicely filters out disturbances.
          </aside>
        </section>

      </section>

      <section style="text-align: left;">
        <h3>Questions? Comments?</h3>
        <!-- <p>
          - <a href="https://slides.com">Try the online editor</a> <br>
          - <a href="https://github.com/hakimel/reveal.js">Source code &amp; documentation</a>
        </p> -->
      </section>

      <section>
        <section>
          <h2>Extras</h2>
        </section>
        <section>
          <h2>How this presentation?</h2>
          <p>https://github.com/hakimel/reveal.js/#full-setup</p>
        </section>

        <section>
          <h2>Codegen: limitations</h2>
          <p>
            <ul>
              <li>
                Only signals, parameters as input, no events
              </li>
              <li>
                Fixed timestep
              </li>
            </ul>
          </p>
        </section>

        <section>
          <h2>Codegen: related work</h2>
          <p>
            <small data-bib-label="kochNeuroflightNextGeneration"></small>
          </p>
        </section>

        <section>
          <h2>Memory requirements</h2>
          <table>
            <th>
            <td>Flash</td>
            <td>RAM</td>
            </th>
            <tr>
              <td>PX4</td>
              <td>2 MB</td>
              <td>256<ref>[1]</ref>-512<ref>[2]</ref> kB</td>
            </tr>
            <tr>
              <td>PPZ</td>
              <td>256<ref>[3]</ref>-1024<ref>[4]</ref> kB</td>
              <td>16<ref>[3]</ref>-192<ref>[4]</ref> kB</td>
            </tr>
          </table>
          <p>
            <small>
              1) <a href="https://docs.px4.io/en/flight_controller/pixracer.html">Pixracer</a> <br>
              2) <a href="https://docs.px4.io/en/flight_controller/pixhawk4.html#quick-summary">Pixhawk 4</a><br>
              3) <a href="https://wiki.paparazziuav.org/wiki/Lisa/S">Lisa/S</a><br>
              4) <a href="https://wiki.paparazziuav.org/wiki/Category:Autopilots">Elle0</a>
            </small>
          </p>
          <aside class="notes" data-markdown>Bridge: What are the limitations?.</aside>
        </section>

        <section>
          <h2>Reference frames</h2>
          <ul>
            <li>
              Body
            </li>
            <li>
              Inertial
            </li>
          </ul>
        </section>

        <section data-background-iframe="https://www.youtube.com/embed/-JVs2XGzLT4?autoplay=1&start=17" data-background>
          <aside class="notes" data-markdown>Kid crash</aside>
        </section>

        <section data-background-iframe="https://www.youtube.com/embed/2nDEEw3VjNU?autoplay=1" data-background>
          <aside class="notes" data-markdown>Dji Inspire 2 losing prop, 3 prop flight</aside>
        </section>

        <section>
          <h2>INDI</h2>
          <pre class="bash">
            <code>
    
              $ echo "Hello, world!"
              $ if [ -e README ]; then
              > echo 'README exists.'
              > else
              > echo "README doesn't exist."
              > fi

            </code>
          </pre>
          <p data-markdown>`$$\boldsymbol{\omega}=\boldsymbol{\omega}_{f}+\left(\boldsymbol{G}_{1}
            \operatorname{diag}\left(\boldsymbol{\omega}_{f}\right)+\boldsymbol{G}_{2}-\boldsymbol{C}\left(\boldsymbol{\Omega}_{f}\right)
            \boldsymbol{G}_{3}\right)^{+}\left(\boldsymbol{\nu}-\dot{\boldsymbol{\Omega}}_{f}+\boldsymbol{G}_{2}
            z^{-1}\left(\boldsymbol{\omega}-\boldsymbol{\omega}_{f}\right)\right)$$`
          </p>
        </section>


        <section>
          <pre class="python"><code>
  import click
  
  from simulink_model import Api, MODEL_CONFIGS
  
  MODELS = MODEL_CONFIGS.keys()
  
  
  @cli.command(help="Run MATLAB code generation.")
  @click.option(
      "--model",
      "-m",
      "models",
      type=click.Choice(MODELS),
      required=True,
      multiple=True,
      help="Model options are defined in `simulink_model/config.py`",
  )
  def codegen(models: Tuple[str]):
      api = Api()
      for model in models:
          api.codegen(MODEL_CONFIGS[model])
              </code></pre>
          <aside class="notes" data-markdown>How it's made</aside>

        </section>


        <section>
          <pre class="python"><code>
  # matlablib.py
  
  class Model:
      """
      Simulink model class.
      """
      def rtwbuild(self) -> RtwBuildDir:
          """
          Build the model and return the `BuildDirectory`,
          among other info in the dict. The `model` must exist in the already loaded system.
          Reference:
          https://mathworks.com/help/rtw/ref/rtwbuild.html
          """
          LOGGER.debug(f"Building model: '{self.model}'")

          self.engine.rtwbuild(self.model)

          rtw_build_dir: RtwBuildDir = self.engine.eval(
              f"RTW.getBuildDir('{self.model}')"
          )

          build_directory = rtw_build_dir["BuildDirectory"]
          LOGGER.debug(f"Build directory: '{build_directory}'")

          codegen_folder = rtw_build_dir["CodeGenFolder"]
          rtw_build_dir["PackNGoZipFile"] = self.get_packngo_zip(
              codegen_folder
          )  # pylint: disable=C0103
          return rtw_build_dir
          </code></pre>
        </section>
        <section>
          <section>
            <h2>Tikz</h2>
            <script type="text/tikz">
              \begin{tikzpicture}
                \draw (0,0) circle (1in);
              \end{tikzpicture}
            </script>
          </section>
        </section>

        <!-- <section data-background-iframe="https://www.urbandictionary.com/define.php?term=pissing%20contest">
        </section> -->
      </section>

      <section>
        <section>
          <h2>PX4</h2>
          <ul>
            <li>
              Organized around uORB, modules
            </li>
          </ul>
          <p>
          </p>
        </section>

        <section id="uorbgraph" class="fig-container" data-file="uorbgraph.html" data-state="uorbgraph">
        </section>
        <style>
          /* Makes background interactive by removing transparent background element */
          .uorbgraph .slide-background-content {
            display: none;
          }
        </style>

      </section>
    </div>

  </div>

  <script src="../lib/js/head.min.js"></script>
  <script src="../js/reveal.js"></script>

  <script>

    // More info https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      controlsTutorial: false,

      transition: 'slide', // none/fade/slide/convex/concave/zoom

      math: {
        mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
        config: 'TeX-AMS_HTML-full',  // See http://docs.mathjax.org/en/latest/config-files.html
        katexScript: '../plugin/math-katex/lib/katex-0.7.1/katex.min.js',
        katexStylesheet: '../plugin/math-katex/lib/katex-0.7.1/katex.min.css'
      },
      // More info https://github.com/hakimel/reveal.js#dependencies
      dependencies: [
        { src: '../lib/js/classList.js', condition: function () { return !document.body.classList; } },
        { src: '../plugin/markdown/marked.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        { src: '../plugin/markdown/markdown.js', condition: function () { return !!document.querySelector('[data-markdown]'); } },
        { src: '../plugin/highlight/highlight.js', async: true, callback: function () { hljs.initHighlightingOnLoad(); } },
        { src: '../plugin/search/search.js', async: true },
        { src: '../plugin/zoom-js/zoom.js', async: true },
        { src: '../plugin/notes/notes.js', async: true },
        { src: '../plugin/math/math.js', async: true },
        // { src: '../plugin/math-katex/math-katex.js', async: true }, // interferes with d3/uorbgraph
        { src: '../node_modules/reveald3/reveald3.js' },
      ],

      keyboard: {
        '82': () => { // r
          replayVid()
          // toggleControls(getPresentBackgroundVideo())
        },
        '34': () => { // page down
          PAUSED_VID ? playVid() : Reveal.next()
        },
        '32': () => { // space
          Reveal.isOverview() ? Reveal.deactivateOverview() : event.shiftKey ? Reveal.navigatePrev() : PAUSED_VID ? playVid() : Reveal.navigateNext()
        }
      }

    });

    revealInitialized.forEach(fun => fun(Reveal));

    Reveal.addEventListener('prop-eject', () => {
      setTimeout(() => {
        const video = getPresentBackgroundVideo()
        video.addEventListener('timeupdate', (e) => setPropEjectTime(e.target.currentTime))
        video.setAttribute("controls", "controls")
      })
    })

    function setPropEjectTime(currentTime) {
      const slowMoMs = Math.max(Math.round((currentTime - 1.5) / 32 * 1000), 0)
      const samples = Math.round(slowMoMs / 2)
      const displayString = `${slowMoMs} ms<br>${samples} samples`
      propEjectTime.innerHTML = displayString
    }

    function getPresentBackgroundVideo() {
      return Reveal.getCurrentSlide().slideBackgroundElement.querySelector('video')
      // return document.querySelector('.stack.present .present video')
    }

    function getBackgroundVideos() {
      return document.querySelector('video')
    }

    function toggleControls(video) {
      // https://stackoverflow.com/questions/5399412/html5-video-show-hide-controls-programmatically
      if (video.hasAttribute("controls")) {
        video.removeAttribute("controls")
      } else {
        video.setAttribute("controls", "controls")
      }
    }

    // function setTimes() {
    //   document.querySelector('section').forEach((section) => {
    //     if (section.hasAttribute('data-background-video') && section.hasAttribute('data-video-start')) {
    //     }
    //   })
    // }

    PAUSED_VID = false;

    Reveal.addEventListener('slidechanged', event => {
      const slide = event.currentSlide
      const time = getVidStartTime(slide)

      // can't find video element without timeout
      setTimeout(() => {
        if (time) {
          // const video = slide.slideBackgroundElement.querySelector('video');
          const video = getPresentBackgroundVideo()
          if (!video) {
            PAUSED_VID = false;
            return
          }
          video.currentTime = time
          video.pause()
          PAUSED_VID = true;

        }
      }, 0)
    })

    function getVidStartTime(slide) {
      return slide.getAttribute('data-video-time')
    }

    function replayVid() {
      const slide = Reveal.getCurrentSlide
      const video = getPresentBackgroundVideo()
      if (!video) {
        return
      }
      const time = getVidStartTime(video)
      video.currentTime = time
      video.play()
      PAUSED_VID = false;
    }

    function playVid() {
      const video = getPresentBackgroundVideo()
      if (video) {
        video.play()
      } else {
        Reveal.next()
      }
      PAUSED_VID = false
    }

  </script>

</body>

</html>